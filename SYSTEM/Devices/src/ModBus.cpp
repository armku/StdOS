#include "Modbus.h"
#include "SerialPort.h"
#include "string.h"

void ModbusSlave::Process(Buffer &bs, void *para)
{
    SerialPort *sp = (SerialPort*)para;
    debug_printf("%s 收到：[%d]", sp->Name, bs.Length());
    bs.Show(true);
    if (IsFrameOK(bs))
    {
        debug_printf("正确数据帧\r\n");
        byte *buf = bs.GetBuffer();

        //广播地址或本机地址，响应
        if ((buf[0] == 0) || (buf[0] == this->id))
        {
            this->Entity.Function = (MBFunction)buf[1];
            //add: 添加处理
        }
    }
    else
    {
        debug_printf("错误数据帧\r\n");
    }
}

/// <summary>
/// 计算CRC校验码(0：地位，1：高位)
/// </summary>
/// <param name="byteData">输入参数：CRC值</param>
/// <returns>返回值：byte[]，2位，0：地位，1：高位</returns>
ushort ModbusSlave::GetCRC(byte *byteData, int len)
{
    ushort wCrc = 0xFFFF;
    for (int i = 0; i < len; i++)
    {
        wCrc ^= (ushort)(byteData[i]);
        for (int j = 0; j < 8; j++)
        {
            if ((wCrc &0x0001) == 1)
            {
                wCrc >>= 1;
                wCrc ^= 0xA001; //异或多项式
            }
            else
            {
                wCrc >>= 1;
            }
        }
    }

    return wCrc;
}

//完整的一帧数据
//demo:01 03 00 00 00 28 45 D4 
bool ModbusSlave::IsFrameOK(Buffer &bs)
{
    ushort crc = 0;
    ushort crcrcv = 0;
    if (bs.Length() < 6)
    {
        return false;
    }
    crc = this->GetCRC(bs.GetBuffer(), bs.Length() - 2);
    crcrcv = bs.GetBuffer()[bs.Length() - 1];
    crcrcv <<= 8;
    crcrcv |= bs.GetBuffer()[bs.Length() - 2];
	printf("%x %x %x\r\n",crcrcv,crc,GetCRC(bs.GetBuffer(),bs.Length()-2));
    if (crcrcv == crc)
    {
        return true;
    }
    else
    {
        return false;
    }
}


ModbusEntity ModbusSlave::Process(ModbusEntity entity)
{
    // 如果是广播消息，则设置主站ID，便于其他人知道我的主站ID    
    switch (entity.Function)
    {
        case ReadCoils:
        case ReadInputs:
            //            entity = ReadCoils(entity);
            break;
        case ReadHoldingRegisters:
        case ReadInputRegisters:
            //            entity = ReadRegisters(entity);
            break;
        case WriteSingleCoil:
            //            entity = WriteSingleCoil(entity);
            break;
        case WriteSingleRegister:
            //            entity = WriteSingleRegister(entity);
            break;
        case WriteMultipleCoils:
            //            entity = WriteMultipleCoils(entity);
            break;
        case WriteMultipleRegisters:
            //            entity = WriteMultipleRegisters(entity);
            break;
        case Diagnostics:
            //            entity = Diagnostics(entity);
            break;
        case ReportIdentity:
            //            entity = ReportIdentity(entity);
            break;
        default:
            // 不支持的功能码
            //            return entity.SetError(Errors.FunctionCode);
    }

    return entity;
}
